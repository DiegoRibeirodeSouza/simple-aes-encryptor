#!/bin/bash
# Script para Criptografar Vários Arquivos em UM SÓ ARQUIVO (AES)

# Pede a senha usando Zenity (uma única vez)
PASSWORD=$(zenity --password --title="Criptografar Seleção (AES)" --text="Digite a senha para criar um arquivo único criptografado:")

if [ -z "$PASSWORD" ]; then
    exit 1
fi

# Nome do arquivo de saída baseado na data/hora
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
ARCHIVE_NAME="Encrypted_Archive_$TIMESTAMP.tar"

# Coleta os arquivos selecionados
FILES=""
IFS=$'\n'
for FILE in $CAJA_SCRIPT_SELECTED_FILE_PATHS; do
    if [ -e "$FILE" ]; then
        # Adiciona aspas para proteger espaços
        FILES="$FILES \"$FILE\""
    fi
done

if [ -z "$FILES" ]; then
    zenity --error --text="Nenhum arquivo selecionado."
    exit 1
fi

# Comando para criar o tar e depois criptografar
# Usamos 'eval' para interpretar corretamente as aspas nos nomes dos arquivos
CMD="echo 'Criando pacote unificado: $ARCHIVE_NAME...'; \
     eval tar -cvf \"$ARCHIVE_NAME\" $FILES; \
     echo '----------------------------------------'; \
     echo 'Criptografando pacote...'; \
     simple-encryptor-cli -e \"$ARCHIVE_NAME\" -p \"$PASSWORD\" --algo AES -v; \
     echo '----------------------------------------'; \
     echo 'Removendo arquivo temporário...'; \
     rm \"$ARCHIVE_NAME\"; \
     echo 'Concluído! Arquivo gerado: $ARCHIVE_NAME.encrypted'"

# Executa no terminal
mate-terminal --title="Encrypting Single Archive (AES)" --geometry=100x30 -- sh -c "$CMD; echo; read -p 'Pressione Enter para fechar...' confirm"
